<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Norgesvarsel â€“ ren symbol_code-test (Oslo)</title>
<style>
  :root { --bg:#0b132b; --fg:#eef; --muted:#9fb3c8; --card:#1c2541; --accent:#5bc0be; }
  body { margin:0; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:var(--bg); color:var(--fg); display:flex; min-height:100vh; }
  .wrap { margin:auto; width:min(920px, 96vw); }
  header { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:14px; }
  h1 { margin:0; font-size:18px; }
  .seg { display:flex; background:#0f1a33; border:1px solid #2b3558; border-radius:10px; overflow:hidden; }
  .seg label { padding:8px 12px; cursor:pointer; color:#9fb3c8; }
  .seg input { display:none; }
  .seg input:checked + span { background:var(--accent); color:#001017; }
  button { background:#111a2f; color:var(--fg); border:1px solid #2b3558; padding:8px 10px; border-radius:8px; cursor:pointer; }
  .panel { background:var(--card); border:1px solid #2b3558; border-radius:14px; padding:14px; }
  .legend { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:10px; }
  .legend small { color:#9fb3c8; }
  .triplet { display:flex; gap:14px; flex-wrap:wrap; }
  .icard { width:110px; background:#0f1a33; border:1px solid #2b3558; border-radius:10px; padding:10px; display:flex; flex-direction:column; align-items:center; gap:6px; }
  .icard img { width:56px; height:56px; }
  .icard .label { font-weight:600; }
  .meta { font-size:12px; color:#9fb3c8; }
  .err { color:#ffb4b4; }
  .footer { margin-top:10px; font-size:12px; color:#b9c5d6; opacity:.85; display:flex; justify-content:space-between; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ðŸ‡³ðŸ‡´ Norgesvarsel â€“ symbol_code-test (Oslo)</h1>
    <div class="seg" role="tablist" aria-label="Visning">
      <label><input type="radio" name="mode" value="weekend" checked><span>FÃ¸rstkommende helg</span></label>
      <label><input type="radio" name="mode" value="next3"><span>Neste 3 dager</span></label>
      <label><input type="radio" name="mode" value="plus7"><span>+7 til +9 dager</span></label>
    </div>
    <button id="refresh">Oppdater</button>
  </header>

  <div class="panel">
    <div class="legend">
      <div>
        <strong id="legend-title">FÃ¸rstkommende helg</strong><br>
        <small id="legend-sub">Symboler rundt kl. 12 (lokal tid)</small>
      </div>
      <div class="meta">Kilde: MET Locationforecast 2.0 (symbol_code)</div>
    </div>

    <div id="box" class="triplet"></div>
    <div id="error" class="meta err" style="display:none;"></div>

    <div class="footer">
      <div>Test v1.0â€“symbol_code â€¢ Oslo (59.913, 10.739)</div>
      <div>Ikoner: MET weathericons (SVG)</div>
    </div>
  </div>
</div>

<script>
'use strict';

// ---- Konfig (kun MET compact) ----
const ICON_BASE = "https://cdn.jsdelivr.net/gh/metno/weathericons/weather/svg/";
const OSLO = { lat: 59.913, lon: 10.739 }; // sentrum

// ---- Tid ----
function localNoonNDaysFromNow(n){
  const d=new Date();
  d.setDate(d.getDate()+n);
  d.setHours(12,0,0,0);
  return d;
}
function upcomingWeekendNoons(){
  const now=new Date();
  const dow=now.getDay(); // 0=Sun..6=Sat
  const daysToFriday=(5-dow+7)%7;
  return [localNoonNDaysFromNow(daysToFriday),
          localNoonNDaysFromNow(daysToFriday+1),
          localNoonNDaysFromNow(daysToFriday+2)];
}

// ---- MET Locationforecast (symbol_code) ----
async function fetchMet(lat, lon){
  const url=`https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=${lat}&lon=${lon}`;
  const res=await fetch(url);
  if(!res.ok) throw new Error(`MET ${res.status}`);
  return res.json();
}
function pickSymbolCodeAtLocalNoon(metForecast, dateObj){
  const ts = metForecast?.properties?.timeseries || [];
  if(!ts.length) return null;

  // finn nÃ¦rmeste timeserie-punkt til lokal 12:00 (UTC i API)
  const target = dateObj.getTime();
  let best=null, bestDiff=Infinity;
  for(const row of ts){
    const t=Date.parse(row.time);
    const diff=Math.abs(t-target);
    if(diff<bestDiff){ best=row; bestDiff=diff; }
  }
  if(!best) return null;

  const d = best.data || {};
  // anbefalt prioritet pÃ¥ summaries
  return d.next_6_hours?.summary?.symbol_code
      || d.next_1_hours?.summary?.symbol_code
      || d.next_12_hours?.summary?.symbol_code
      || null;
}

// ---- UI ----
function card(dateObj, code){
  const div=document.createElement("div"); div.className="icard";
  const img=document.createElement("img");
  const label=document.createElement("div"); label.className="label";
  const sub=document.createElement("div"); sub.className="meta";

  label.textContent=dateObj.toLocaleDateString("no-NO",{weekday:"short",day:"2-digit",month:"short"});

  if(code){
    img.src=ICON_BASE + code + ".svg";
    img.alt=code.replace(/_/g," ");
    sub.textContent=code;
  }else{
    img.alt="ingen data";
    sub.textContent="mangler symbol_code";
  }

  div.appendChild(img); div.appendChild(label); div.appendChild(sub);
  return div;
}

function setLegend(mode){
  const t=document.getElementById("legend-title");
  const s=document.getElementById("legend-sub");
  if(mode==="weekend"){ t.textContent="FÃ¸rstkommende helg"; s.textContent="Symboler rundt kl. 12 (freâ€“sÃ¸n)"; }
  else if(mode==="next3"){ t.textContent="Neste 3 dager"; s.textContent="Symboler rundt kl. 12 (lokal tid)"; }
  else { t.textContent="+7 til +9 dager"; s.textContent="Symboler rundt kl. 12 (lokal tid)"; }
}

// ---- Render ----
async function render(){
  const mode=document.querySelector('input[name="mode"]:checked').value;
  setLegend(mode);

  const box=document.getElementById("box");
  const err=document.getElementById("error");
  box.innerHTML=""; err.style.display="none"; err.textContent="";

  // velg datoer
  const now=new Date(), dow=now.getDay();
  const dates = mode==="weekend" ? upcomingWeekendNoons()
              : mode==="next3"   ? ((dow===5)?[localNoonNDaysFromNow(0),localNoonNDaysFromNow(1),localNoonNDaysFromNow(2)]
                                         : [localNoonNDaysFromNow(1),localNoonNDaysFromNow(2),localNoonNDaysFromNow(3)])
                                  : [localNoonNDaysFromNow(7),localNoonNDaysFromNow(8),localNoonNDaysFromNow(9)];

  try{
    const met = await fetchMet(OSLO.lat, OSLO.lon);
    dates.forEach(d=>{
      const code = pickSymbolCodeAtLocalNoon(met, d);  // <-- KUN symbol_code
      box.appendChild(card(d, code));
    });
  }catch(e){
    err.textContent=`Feil: ${e.message}`;
    err.style.display="block";
    console.error(e);
  }
}

document.getElementById("refresh").addEventListener("click", render);
document.querySelectorAll('input[name="mode"]').forEach(r=>r.addEventListener("change", render));
render();
</script>
</body>
</html>
