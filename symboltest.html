<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Norgesvarsel â€“ ID test (Oslo)</title>
<style>
  :root { --bg:#0b132b; --fg:#eef; --muted:#9fb3c8; --card:#1c2541; --accent:#5bc0be; }
  body { margin:0; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:var(--bg); color:var(--fg); display:flex; min-height:100vh; }
  .wrap { margin:auto; width:min(920px, 96vw); }
  header { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:14px; }
  h1 { margin:0; font-size:18px; }
  .seg { display:flex; background:#0f1a33; border:1px solid #2b3558; border-radius:10px; overflow:hidden; }
  .seg label { padding:8px 12px; cursor:pointer; color:#9fb3c8; }
  .seg input { display:none; }
  .seg input:checked + span { background:var(--accent); color:#001017; }
  button { background:#111a2f; color:var(--fg); border:1px solid #2b3558; padding:8px 10px; border-radius:8px; cursor:pointer; }
  .panel { background:var(--card); border:1px solid #2b3558; border-radius:14px; padding:14px; }
  .legend { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:10px; }
  .legend small { color:#9fb3c8; }
  .triplet { display:flex; gap:14px; flex-wrap:wrap; }
  .icard { width:110px; background:#0f1a33; border:1px solid #2b3558; border-radius:10px; padding:10px; display:flex; flex-direction:column; align-items:center; gap:6px; }
  .icard img { width:56px; height:56px; }
  .icard .label { font-weight:600; }
  .meta { font-size:12px; color:#9fb3c8; }
  .err { color:#ffb4b4; }
  .footer { margin-top:10px; font-size:12px; color:#b9c5d6; opacity:.85; display:flex; justify-content:space-between; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ðŸ‡³ðŸ‡´ Norgesvarsel â€“ Oslo (ID-test)</h1>
    <div class="seg" role="tablist" aria-label="Visning">
      <label><input type="radio" name="mode" value="weekend" checked><span>FÃ¸rstkommende helg</span></label>
      <label><input type="radio" name="mode" value="next3"><span>Neste 3 dager</span></label>
      <label><input type="radio" name="mode" value="plus7"><span>+7 til +9 dager</span></label>
    </div>
    <button id="refresh">Oppdater</button>
  </header>

  <div class="panel">
    <div class="legend">
      <div>
        <strong id="legend-title">FÃ¸rstkommende helg</strong><br>
        <small id="legend-sub">Symboler rundt kl. 12 (lokal tid)</small>
      </div>
      <div class="meta">Kilde: yr.no /api/v0/locations/<code>1-72837</code>/forecast</div>
    </div>

    <div id="box" class="triplet"></div>
    <div id="error" class="meta err" style="display:none;"></div>

    <div class="footer">
      <div>Test v1.2-ID â€¢ Oslo ID: <code>1-72837</code></div>
      <div>Ikoner: MET weathericons (SVG)</div>
    </div>
  </div>
</div>

<script>
'use strict';

// ===== Konfig =====
const ICON_BASE = "https://cdn.jsdelivr.net/gh/metno/weathericons/weather/svg/";
const OSLO_ID = "1-72837";

// CORS: enkel proxy nÃ¥ (AllOrigins). For produksjon er Cloudflare Worker best.
const USE_PROXY = true;
const WORKER_URL = ""; // "https://din-worker.workers.dev/?u=" hvis du lager Worker

// ===== Tidsvalg =====
function localNoonNDaysFromNow(n) {
  const d = new Date();
  d.setDate(d.getDate() + n);
  d.setHours(12,0,0,0);
  return d;
}
function upcomingWeekendNoons() {
  const now = new Date();
  const dow = now.getDay(); // 0=Sun ... 6=Sat
  const daysToFriday = (5 - dow + 7) % 7;
  return [localNoonNDaysFromNow(daysToFriday),
          localNoonNDaysFromNow(daysToFriday+1),
          localNoonNDaysFromNow(daysToFriday+2)];
}

// ===== Yr API (ID) =====
async function fetchById(id) {
  const yrUrl = `https://www.yr.no/api/v0/locations/${id}/forecast`;
  let url = yrUrl;
  if (USE_PROXY) {
    url = WORKER_URL
      ? WORKER_URL + encodeURIComponent(yrUrl)
      : `https://api.allorigins.win/raw?url=${encodeURIComponent(yrUrl)}`;
  }
  const res = await fetch(url);
  if (!res.ok) throw new Error(`Yr API ${res.status}`);
  return res.json();
}

// --- Robust uthenting av symbolkode uansett struktur ---
function getSymbolCodeAny(interval) {
  // 1) symbol direkte som streng
  if (typeof interval.symbol === "string") return interval.symbol;
  // 2) symbol som objekt med felt
  if (interval.symbol && typeof interval.symbol === "object") {
    if (typeof interval.symbol.code === "string") return interval.symbol.code;
    if (typeof interval.symbol.id === "string")   return interval.symbol.id;
    if (typeof interval.symbol.name === "string") return interval.symbol.name;
  }
  // 3) alternative felt
  if (typeof interval.symbolCode === "string") return interval.symbolCode;
  if (typeof interval.symbol_code === "string") return interval.symbol_code;
  // 4) ellers prÃ¸v Ã¥ stringify'e forsiktig
  if (interval.symbol != null) return String(interval.symbol);
  return null;
}

// --- Velg symbol (longIntervals foretrukket; fallback til shortIntervals) ---
function pickFromIntervals(arr, targetMs) {
  if (!arr || !arr.length) return null;

  // intervall som dekker tidspunktet
  for (const it of arr) {
    const start = Date.parse(it.start);
    const end   = Date.parse(it.end);
    if (isFinite(start) && isFinite(end) && targetMs >= start && targetMs < end) {
      return getSymbolCodeAny(it);
    }
  }
  // nÃ¦rmest start
  let best=null, bestDiff=Infinity;
  for (const it of arr) {
    const start = Date.parse(it.start);
    if (!isFinite(start)) continue;
    const diff = Math.abs(start - targetMs);
    if (diff < bestDiff) { best = it; bestDiff = diff; }
  }
  return best ? getSymbolCodeAny(best) : null;
}

function pickSymbolForDate(forecast, targetDate) {
  const t = targetDate.getTime();
  return (
    pickFromIntervals(forecast.longIntervals, t) ||
    pickFromIntervals(forecast.shortIntervals, t) ||
    null
  );
}

// ===== UI-kort =====
function cardForSymbol(dateObj, symbolCodeRaw) {
  const div = document.createElement("div");
  div.className = "icard";
  const img = document.createElement("img");
  const label = document.createElement("div"); label.className = "label";
  const sub = document.createElement("div"); sub.className = "meta";

  const dd = dateObj.toLocaleDateString("no-NO", { weekday:"short", day:"2-digit", month:"short" });
  label.textContent = dd;

  const code = (symbolCodeRaw != null) ? String(symbolCodeRaw) : ""; // tving til streng
  if (code) {
    img.src = ICON_BASE + code + ".svg";
    img.alt = code.replace(/_/g, " ");  // regex i stedet for replaceAll
    sub.textContent = code;
  } else {
    img.alt = "ingen data";
    sub.textContent = "mangler symbol";
  }
  div.appendChild(img); div.appendChild(label); div.appendChild(sub);
  return div;
}

// ===== Render (Oslo) =====
async function render() {
  const mode = document.querySelector('input[name="mode"]:checked').value;
  const t = document.getElementById("legend-title");
  const s = document.getElementById("legend-sub");
  if (mode === "weekend") { t.textContent = "FÃ¸rstkommende helg"; s.textContent = "Symboler rundt kl. 12 (freâ€“sÃ¸n)"; }
  else if (mode === "next3") { t.textContent = "Neste 3 dager"; s.textContent = "Symboler rundt kl. 12 lokal tid"; }
  else { t.textContent = "+7 til +9 dager"; s.textContent = "Symboler rundt kl. 12 lokal tid"; }

  const box = document.getElementById("box");
  const err = document.getElementById("error");
  box.innerHTML = ""; err.style.display = "none"; err.textContent = "";

  // datoer
  const now = new Date();
  const dow = now.getDay();
  let dates = [];
  if (mode === "weekend") {
    dates = upcomingWeekendNoons();
  } else if (mode === "next3") {
    dates = (dow === 5) ? [ localNoonNDaysFromNow(0), localNoonNDaysFromNow(1), localNoonNDaysFromNow(2) ]
                        : [ localNoonNDaysFromNow(1), localNoonNDaysFromNow(2), localNoonNDaysFromNow(3) ];
  } else {
    dates = [ localNoonNDaysFromNow(7), localNoonNDaysFromNow(8), localNoonNDaysFromNow(9) ];
  }

  try {
    const forecast = await fetchById(OSLO_ID);
    dates.forEach(d => {
      const code = pickSymbolForDate(forecast, d);
      box.appendChild(cardForSymbol(d, code));
    });
  } catch (e) {
    err.textContent = `Feil fra Yr: ${e.message}`;
    err.style.display = "block";
    console.error("Yr-feil (Oslo)", e);
  }
}

// Events
document.getElementById("refresh").addEventListener("click", render);
document.querySelectorAll('input[name="mode"]').forEach(r => r.addEventListener("change", render));

// FÃ¸rste kjÃ¸ring
render();
</script>
</body>
</html>
