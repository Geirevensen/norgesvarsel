<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Norgesvarsel â€“ Oslo (ID-test)</title>
<style>
  :root { --bg:#0b132b; --fg:#eef; --muted:#9fb3c8; --card:#1c2541; --accent:#5bc0be; }
  body { margin:0; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:var(--bg); color:var(--fg); display:flex; min-height:100vh; }
  .wrap { margin:auto; width:min(920px, 96vw); }
  header { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:14px; }
  h1 { margin:0; font-size:18px; }
  .seg { display:flex; background:#0f1a33; border:1px solid #2b3558; border-radius:10px; overflow:hidden; }
  .seg label { padding:8px 12px; cursor:pointer; color:#9fb3c8; }
  .seg input { display:none; }
  .seg input:checked + span { background:var(--accent); color:#001017; }
  button { background:#111a2f; color:var(--fg); border:1px solid #2b3558; padding:8px 10px; border-radius:8px; cursor:pointer; }
  .panel { background:var(--card); border:1px solid #2b3558; border-radius:14px; padding:14px; }
  .legend { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:10px; }
  .legend small { color:#9fb3c8; }
  .triplet { display:flex; gap:14px; flex-wrap:wrap; }
  .icard { width:110px; background:#0f1a33; border:1px solid #2b3558; border-radius:10px; padding:10px; display:flex; flex-direction:column; align-items:center; gap:6px; }
  .icard img { width:56px; height:56px; }
  .icard .label { font-weight:600; }
  .meta { font-size:12px; color:#9fb3c8; }
  .err { color:#ffb4b4; }
  .footer { margin-top:10px; font-size:12px; color:#b9c5d6; opacity:.85; display:flex; justify-content:space-between; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ðŸ‡³ðŸ‡´ Norgesvarsel â€“ Oslo (ID-test)</h1>
    <div class="seg" role="tablist" aria-label="Visning">
      <label><input type="radio" name="mode" value="weekend" checked><span>FÃ¸rstkommende helg</span></label>
      <label><input type="radio" name="mode" value="next3"><span>Neste 3 dager</span></label>
      <label><input type="radio" name="mode" value="plus7"><span>+7 til +9 dager</span></label>
    </div>
    <button id="refresh">Oppdater</button>
  </header>

  <div class="panel">
    <div class="legend">
      <div>
        <strong id="legend-title">FÃ¸rstkommende helg</strong><br>
        <small id="legend-sub">Symboler rundt kl. 12 (lokal tid)</small>
      </div>
      <div class="meta">Kilde: Yr (ID) med fallback til MET Locationforecast</div>
    </div>

    <div id="box" class="triplet"></div>
    <div id="error" class="meta err" style="display:none;"></div>

    <div class="footer">
      <div>Test v1.4-ID â€¢ Oslo ID: <code>1-72837</code></div>
      <div>Ikoner: MET weathericons (SVG)</div>
    </div>
  </div>
</div>

<script>
'use strict';

// ===== Konfig =====
const ICON_BASE = "https://cdn.jsdelivr.net/gh/metno/weathericons/weather/svg/";
const OSLO_ID = "1-72837";
const OSLO_LAT = 59.913; // fallback til MET
const OSLO_LON = 10.739;

// CORS for GitHub Pages
const USE_PROXY = true;
const WORKER_URL = ""; // f.eks. "https://din-worker.workers.dev/?u=" nÃ¥r du har den

// ===== Tidsvalg =====
function localNoonNDaysFromNow(n) {
  const d = new Date();
  d.setDate(d.getDate() + n);
  d.setHours(12,0,0,0);
  return d;
}
function upcomingWeekendNoons() {
  const now = new Date();
  const dow = now.getDay(); // 0=Sun..6=Sat
  const daysToFriday = (5 - dow + 7) % 7;
  return [localNoonNDaysFromNow(daysToFriday),
          localNoonNDaysFromNow(daysToFriday+1),
          localNoonNDaysFromNow(daysToFriday+2)];
}

// ===== Hjelpere =====
function filenameBase(u) {
  try {
    const s = String(u);
    const last = s.split("/").pop() || "";
    return last.replace(/\.svg(\?.*)?$/i, "");
  } catch { return null; }
}
// Plukk ut symbolkode fra et "symbol"-felt uansett form
function extractCodeFromSymbol(sym) {
  if (!sym) return null;
  if (typeof sym === "string") {
    // Kan vÃ¦re "clearsky_day" eller en full URL til svg
    return /\.svg/i.test(sym) ? filenameBase(sym) : sym;
  }
  if (typeof sym === "object") {
    // Vanlige nÃ¸kler
    if (typeof sym.code === "string") return sym.code;
    if (typeof sym.symbolCode === "string") return sym.symbolCode;
    if (typeof sym.symbol_code === "string") return sym.symbol_code;
    if (typeof sym.id === "string") return sym.id;
    if (typeof sym.name === "string") return sym.name.toLowerCase().replace(/ /g, "_");
    // Ikon-URLer
    if (sym.icon && typeof sym.icon === "object") {
      const c = filenameBase(sym.icon.svg || sym.icon.url || sym.icon.png);
      if (c) return c;
    }
    if (typeof sym.svg === "string" || typeof sym.url === "string" || typeof sym.png === "string") {
      const c = filenameBase(sym.svg || sym.url || sym.png);
      if (c) return c;
    }
    // Rekursiv jakt pÃ¥ fÃ¸rste streng eller .svg
    for (const k in sym) {
      const v = sym[k];
      if (typeof v === "string") {
        if (/\.svg(\?.*)?$/i.test(v)) return filenameBase(v);
        if (/^[a-z_]+$/i.test(v)) return v;
      }
      if (v && typeof v === "object") {
        const inner = extractCodeFromSymbol(v);
        if (inner) return inner;
      }
    }
  }
  return null;
}
function symbolFromIntervals(intervals, targetMs) {
  if (!intervals || !intervals.length) return null;
  // 1) Intervall som dekker tidspunktet
  for (const it of intervals) {
    const s = Date.parse(it.start), e = Date.parse(it.end);
    if (isFinite(s) && isFinite(e) && targetMs >= s && targetMs < e) {
      return extractCodeFromSymbol(it.symbol) || extractCodeFromSymbol(it);
    }
  }
  // 2) NÃ¦rmeste start
  let best=null, diff=Infinity;
  for (const it of intervals) {
    const s = Date.parse(it.start);
    if (!isFinite(s)) continue;
    const d = Math.abs(targetMs - s);
    if (d < diff) { best = it; diff = d; }
  }
  return best ? (extractCodeFromSymbol(best.symbol) || extractCodeFromSymbol(best)) : null;
}

// ===== Hent fra YR (ID) =====
async function fetchYrById(id) {
  const yrUrl = `https://www.yr.no/api/v0/locations/${id}/forecast`;
  let url = yrUrl;
  if (USE_PROXY) {
    url = WORKER_URL ? WORKER_URL + encodeURIComponent(yrUrl)
                     : `https://api.allorigins.win/raw?url=${encodeURIComponent(yrUrl)}`;
  }
  const res = await fetch(url);
  if (!res.ok) throw new Error(`Yr API ${res.status}`);
  return res.json();
}
function pickSymbolFromYr(yrForecast, targetDate) {
  const t = targetDate.getTime();
  // Prioriter longIntervals, sÃ¥ shortIntervals
  return symbolFromIntervals(yrForecast?.longIntervals, t)
      || symbolFromIntervals(yrForecast?.shortIntervals, t)
      || null;
}

// ===== Fallback til MET Locationforecast (lat/lon) =====
async function fetchMet(lat, lon) {
  const url = `https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=${lat}&lon=${lon}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`MET ${res.status}`);
  return res.json();
}
function pickSymbolFromMet(metForecast, targetDate) {
  const ts = metForecast?.properties?.timeseries || [];
  if (!ts.length) return null;
  const T = targetDate.getTime();
  let best = null, diff = Infinity;
  for (const row of ts) {
    const t = Date.parse(row.time);
    const d = Math.abs(T - t);
    if (d < diff) { best = row; diff = d; }
  }
  if (!best) return null;
  const d = best.data || {};
  return d.next_6_hours?.summary?.symbol_code
      || d.next_1_hours?.summary?.symbol_code
      || d.next_12_hours?.summary?.symbol_code
      || null;
}

// ===== UI =====
function cardForSymbol(dateObj, code) {
  const div = document.createElement("div");
  div.className = "icard";
  const img = document.createElement("img");
  const label = document.createElement("div"); label.className = "label";
  const sub = document.createElement("div"); sub.className = "meta";
  const dd = dateObj.toLocaleDateString("no-NO", { weekday:"short", day:"2-digit", month:"short" });
  label.textContent = dd;

  if (code) {
    const c = String(code);
    img.src = ICON_BASE + c + ".svg";
    img.alt = c.replace(/_/g, " ");
    sub.textContent = c;
  } else {
    img.alt = "ingen data";
    sub.textContent = "mangler symbol";
  }
  div.appendChild(img); div.appendChild(label); div.appendChild(sub);
  return div;
}
function setLegend(mode) {
  const t = document.getElementById("legend-title");
  const s = document.getElementById("legend-sub");
  if (mode === "weekend") { t.textContent = "FÃ¸rstkommende helg"; s.textContent = "Symboler rundt kl. 12 (freâ€“sÃ¸n)"; }
  else if (mode === "next3") { t.textContent = "Neste 3 dager"; s.textContent = "Symboler rundt kl. 12 (lokal tid)"; }
  else { t.textContent = "+7 til +9 dager"; s.textContent = "Symboler rundt kl. 12 (lokal tid)"; }
}

// ===== Render (Oslo) =====
async function render() {
  const mode = document.querySelector('input[name="mode"]:checked').value;
  setLegend(mode);
  const box = document.getElementById("box");
  const err = document.getElementById("error");
  box.innerHTML = ""; err.style.display = "none"; err.textContent = "";

  // datoer
  const now = new Date();
  const dow = now.getDay();
  const dates =
    mode === "weekend" ? upcomingWeekendNoons() :
    mode === "next3"   ? ((dow===5)?[localNoonNDaysFromNow(0),localNoonNDaysFromNow(1),localNoonNDaysFromNow(2)]
                                  : [localNoonNDaysFromNow(1),localNoonNDaysFromNow(2),localNoonNDaysFromNow(3)])
                       : [localNoonNDaysFromNow(7),localNoonNDaysFromNow(8),localNoonNDaysFromNow(9)];

  try {
    const yr = await fetchYrById(OSLO_ID);
    dates.forEach(d => {
      let code = pickSymbolFromYr(yr, d);
      if (!code) {
        // Fallback: MET
        code = null; // set null until fetched
        box.appendChild(cardForSymbol(d, null));
      } else {
        box.appendChild(cardForSymbol(d, code));
      }
    });

    // Fyll inn fallback-kort asynkront om noen manglet
    const needFallback = Array.from(box.children)
      .map((card, i) => ({card, i}))
      .filter(x => x.card.querySelector('.meta').textContent === 'mangler symbol');

    if (needFallback.length) {
      const met = await fetchMet(OSLO_LAT, OSLO_LON);
      needFallback.forEach(({card, i}) => {
        const code = pickSymbolFromMet(met, dates[i]);
        const img = card.querySelector('img');
        const meta = card.querySelector('.meta');
        if (code) {
          const c = String(code);
          img.src = ICON_BASE + c + ".svg";
          img.alt = c.replace(/_/g, " ");
          meta.textContent = c;
        } else {
          meta.textContent = "mangler symbol";
        }
      });
    }
  } catch (e) {
    err.textContent = `Feil: ${e.message}`;
    err.style.display = "block";
    console.error(e);
  }
}

document.getElementById("refresh").addEventListener("click", render);
document.querySelectorAll('input[name="mode"]').forEach(r => r.addEventListener("change", render));
render();
</script>
</body>
</html>
