<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Norgesvarsel â€“ Oslo (ID-test)</title>
<style>
  :root { --bg:#0b132b; --fg:#eef; --muted:#9fb3c8; --card:#1c2541; --accent:#5bc0be; }
  body { margin:0; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:var(--bg); color:var(--fg); display:flex; min-height:100vh; }
  .wrap { margin:auto; width:min(920px, 96vw); }
  header { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:14px; }
  h1 { margin:0; font-size:18px; }
  .seg { display:flex; background:#0f1a33; border:1px solid #2b3558; border-radius:10px; overflow:hidden; }
  .seg label { padding:8px 12px; cursor:pointer; color:#9fb3c8; }
  .seg input { display:none; }
  .seg input:checked + span { background:var(--accent); color:#001017; }
  button { background:#111a2f; color:var(--fg); border:1px solid #2b3558; padding:8px 10px; border-radius:8px; cursor:pointer; }
  .panel { background:var(--card); border:1px solid #2b3558; border-radius:14px; padding:14px; }
  .legend { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:10px; }
  .legend small { color:#9fb3c8; }
  .triplet { display:flex; gap:14px; flex-wrap:wrap; }
  .icard { width:110px; background:#0f1a33; border:1px solid #2b3558; border-radius:10px; padding:10px; display:flex; flex-direction:column; align-items:center; gap:6px; }
  .icard img { width:56px; height:56px; }
  .icard .label { font-weight:600; }
  .meta { font-size:12px; color:#9fb3c8; }
  .err { color:#ffb4b4; }
  .footer { margin-top:10px; font-size:12px; color:#b9c5d6; opacity:.85; display:flex; justify-content:space-between; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ðŸ‡³ðŸ‡´ Norgesvarsel â€“ Oslo (ID-test)</h1>
    <div class="seg" role="tablist" aria-label="Visning">
      <label><input type="radio" name="mode" value="weekend" checked><span>FÃ¸rstkommende helg</span></label>
      <label><input type="radio" name="mode" value="next3"><span>Neste 3 dager</span></label>
      <label><input type="radio" name="mode" value="plus7"><span>+7 til +9 dager</span></label>
    </div>
    <button id="refresh">Oppdater</button>
  </header>

  <div class="panel">
    <div class="legend">
      <div>
        <strong id="legend-title">FÃ¸rstkommende helg</strong><br>
        <small id="legend-sub">Symboler rundt kl. 12 (lokal tid)</small>
      </div>
      <div class="meta">Kilde: Yr (ID) med fallback til MET Locationforecast</div>
    </div>

    <div id="box" class="triplet"></div>
    <div id="error" class="meta err" style="display:none;"></div>

    <div class="footer">
      <div>Test v1.5-ID â€¢ Oslo ID: <code>1-72837</code></div>
      <div>Ikoner: MET weathericons (SVG)</div>
    </div>
  </div>
</div>

<script>
'use strict';

const ICON_BASE = "https://cdn.jsdelivr.net/gh/metno/weathericons/weather/svg/";
const OSLO_ID = "1-72837";
const OSLO_LAT = 59.913, OSLO_LON = 10.739;

// GitHub Pages CORS
const USE_PROXY = true;
const WORKER_URL = ""; // sett til "https://din-worker.workers.dev/?u=" hvis du lager Worker

// --- Tid ---
function localNoonNDaysFromNow(n){ const d=new Date(); d.setDate(d.getDate()+n); d.setHours(12,0,0,0); return d; }
function upcomingWeekendNoons(){ const now=new Date(); const dow=now.getDay(); const df=(5-dow+7)%7;
  return [localNoonNDaysFromNow(df), localNoonNDaysFromNow(df+1), localNoonNDaysFromNow(df+2)]; }

// --- Normalisering av ikon-koder ---
function normalizeCode(x){
  if (x == null) return null;
  let s = String(x);
  // hvis det er en .svg-URL â†’ trekk ut filnavn
  if (/\.svg(\?.*)?$/i.test(s)) s = s.split("/").pop().replace(/\.svg(\?.*)?$/i,"");
  // standardiser: smÃ¥ bokstaver, bindestrek/space â†’ _, fjern rare tegn, kondensÃ©r __
  s = s.toLowerCase().replace(/[\s-]+/g,"_").replace(/[^a-z0-9_]+/g,"").replace(/_+/g,"_").replace(/^_|_$/g,"");
  return s || null;
}

// --- Parser for Yr ---
function filenameBase(u){ try{ const last=String(u).split("/").pop()||""; return last.replace(/\.svg(\?.*)?$/i,""); }catch{ return null; } }
function extractCodeFromSymbol(sym){
  if (!sym) return null;
  if (typeof sym === "string") return normalizeCode(sym);
  if (typeof sym === "object"){
    const tryFields = [sym.code, sym.symbolCode, sym.symbol_code, sym.id, sym.name, sym.svg, sym.url, sym.png];
    for (const v of tryFields){ const n = normalizeCode(v); if (n) return n; }
    if (sym.icon && typeof sym.icon === "object"){
      const n = normalizeCode(sym.icon.svg || sym.icon.url || sym.icon.png);
      if (n) return n;
    }
    // dyp jakt
    for (const k in sym){
      const v = sym[k];
      if (typeof v === "string"){ const n = normalizeCode(v); if (n) return n; }
      if (v && typeof v === "object"){ const n = extractCodeFromSymbol(v); if (n) return n; }
    }
  }
  return null;
}
function symbolFromIntervals(intervals, targetMs){
  if (!intervals || !intervals.length) return null;
  for (const it of intervals){
    const s = Date.parse(it.start), e = Date.parse(it.end);
    if (isFinite(s)&&isFinite(e)&&targetMs>=s&&targetMs<e){
      return extractCodeFromSymbol(it.symbol) || extractCodeFromSymbol(it);
    }
  }
  let best=null, diff=Infinity;
  for (const it of intervals){
    const s = Date.parse(it.start); if (!isFinite(s)) continue;
    const d = Math.abs(targetMs - s); if (d<diff){ best=it; diff=d; }
  }
  return best ? (extractCodeFromSymbol(best.symbol) || extractCodeFromSymbol(best)) : null;
}

// --- Hent fra Yr (ID) + fallback til MET ---
async function fetchYrById(id){
  const yrUrl = `https://www.yr.no/api/v0/locations/${id}/forecast`;
  const url = USE_PROXY ? (WORKER_URL ? WORKER_URL + encodeURIComponent(yrUrl)
                                      : `https://api.allorigins.win/raw?url=${encodeURIComponent(yrUrl)}`) : yrUrl;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`Yr API ${res.status}`);
  return res.json();
}
function pickSymbolFromYr(yr, when){ const t=when.getTime();
  return symbolFromIntervals(yr?.longIntervals, t) || symbolFromIntervals(yr?.shortIntervals, t) || null; }

async function fetchMet(lat,lon){
  const url = `https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=${lat}&lon=${lon}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`MET ${res.status}`);
  return res.json();
}
function pickSymbolFromMet(met, when){
  const ts = met?.properties?.timeseries || []; if (!ts.length) return null;
  const T = when.getTime(); let best=null, diff=Infinity;
  for (const r of ts){ const tt=Date.parse(r.time); const d=Math.abs(T-tt); if (d<diff){ best=r; diff=d; } }
  if (!best) return null;
  const d = best.data || {};
  return normalizeCode(d.next_6_hours?.summary?.symbol_code
    || d.next_1_hours?.summary?.symbol_code
    || d.next_12_hours?.summary?.symbol_code
    || null);
}

// --- UI ---
function cardForSymbol(dateObj, code){
  const div=document.createElement("div"); div.className="icard";
  const img=document.createElement("img");
  const label=document.createElement("div"); label.className="label";
  const sub=document.createElement("div"); sub.className="meta";
  label.textContent=dateObj.toLocaleDateString("no-NO",{weekday:"short", day:"2-digit", month:"short"});
  if (code){ img.src=ICON_BASE+code+".svg"; img.alt=code.replace(/_/g," "); sub.textContent=code; }
  else { img.alt="ingen data"; sub.textContent="mangler symbol"; }
  div.appendChild(img); div.appendChild(label); div.appendChild(sub); return div;
}
function setLegend(mode){
  const t=document.getElementById("legend-title"), s=document.getElementById("legend-sub");
  if (mode==="weekend"){ t.textContent="FÃ¸rstkommende helg"; s.textContent="Symboler rundt kl. 12 (freâ€“sÃ¸n)"; }
  else if (mode==="next3"){ t.textContent="Neste 3 dager"; s.textContent="Symboler rundt kl. 12 (lokal tid)"; }
  else { t.textContent="+7 til +9 dager"; s.textContent="Symboler rundt kl. 12 (lokal tid)"; }
}

// --- Render ---
async function render(){
  const mode=document.querySelector('input[name="mode"]:checked').value;
  setLegend(mode);
  const box=document.getElementById("box"); const err=document.getElementById("error");
  box.innerHTML=""; err.style.display="none"; err.textContent="";

  const now=new Date(); const dow=now.getDay();
  const dates = mode==="weekend" ? upcomingWeekendNoons()
              : mode==="next3"   ? ((dow===5)?[localNoonNDaysFromNow(0),localNoonNDaysFromNow(1),localNoonNDaysFromNow(2)]
                                         : [localNoonNDaysFromNow(1),localNoonNDaysFromNow(2),localNoonNDaysFromNow(3)])
                                  : [localNoonNDaysFromNow(7),localNoonNDaysFromNow(8),localNoonNDaysFromNow(9)];

  try{
    const yr = await fetchYrById(OSLO_ID);
    const needFallback = [];
    dates.forEach((d,i)=>{
      const codeYr = normalizeCode(pickSymbolFromYr(yr, d));
      if (codeYr){ box.appendChild(cardForSymbol(d, codeYr)); }
      else { needFallback.push(i); box.appendChild(cardForSymbol(d, null)); }
    });

    if (needFallback.length){
      const met = await fetchMet(OSLO_LAT, OSLO_LON);
      needFallback.forEach(i=>{
        const codeMet = pickSymbolFromMet(met, dates[i]);
        const card = box.children[i];
        const img = card.querySelector("img");
        const meta = card.querySelector(".meta");
        if (codeMet){ img.src=ICON_BASE+codeMet+".svg"; img.alt=codeMet.replace(/_/g," "); meta.textContent=codeMet; }
      });
    }
  }catch(e){
    err.textContent=`Feil: ${e.message}`; err.style.display="block"; console.error(e);
  }
}

document.getElementById("refresh").addEventListener("click", render);
document.querySelectorAll('input[name="mode"]').forEach(r=>r.addEventListener("change", render));
render();
</script>
</body>
</html>
