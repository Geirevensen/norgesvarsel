<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Norgesvarsel – Oslo ikoner på kart</title>
<style>
  :root { --accent:#5bc0be; }
  body { margin:0; background:#0b132b; }
  .mapwrap { position:relative; height:100vh; }
  .mapwrap img { width:100%; height:100%; object-fit:contain; display:block; background:#0e1b34; }
  .pin { position:absolute; width:12px; height:12px; border-radius:50%; background:var(--accent); border:2px solid #001017; transform:translate(-50%,-50%); box-shadow:0 0 0 4px rgba(91,192,190,.22); }
  .icons { position:absolute; display:flex; gap:6px; }
  .icons img { width:48px; height:48px; }
  @media (max-width:560px){ .icons img { width:36px; height:36px; } }
</style>
</head>
<body>
<div class="mapwrap" id="mapwrap">
  <img id="mapimg" src="./no.svg" alt="Kart over Norge">
  <div id="pin" class="pin"></div>
  <div id="icons" class="icons"></div>
</div>

<script>
'use strict';

const ICON_BASE = "https://cdn.jsdelivr.net/gh/metno/weathericons/weather/svg/";
const OSLO = { lat:59.913, lon:10.739 };

const BBOX = { lonMin: 4.4, lonMax: 33.7, latMin: 57.9, latMax: 71.6 };
function mercY(lat){ const r=Math.max(-85,Math.min(85,lat))*Math.PI/180; return Math.log(Math.tan(Math.PI/4+r/2)); }
function projectLonLat(lon,lat){
  const x=(lon-BBOX.lonMin)/(BBOX.lonMax-BBOX.lonMin);
  const yTop=mercY(BBOX.latMax), yBot=mercY(BBOX.latMin);
  const y=(yTop-mercY(lat))/(yTop-yBot);
  return {x,y};
}
function getRect(){
  const wrap=document.getElementById("mapwrap");
  const img=document.getElementById("mapimg");
  const box=wrap.getBoundingClientRect();
  const nw=img.naturalWidth||1000, nh=img.naturalHeight||1000;
  const s=Math.min(box.width/nw, box.height/nh);
  const cw=nw*s, ch=nh*s;
  const ox=(box.width-cw)/2, oy=(box.height-ch)/2;
  return {ox,oy,w:cw,h:ch};
}

async function fetchMet(lat,lon){
  const url=`https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=${lat}&lon=${lon}`;
  const res=await fetch(url);
  if(!res.ok) throw new Error(`MET ${res.status}`);
  return res.json();
}
function localNoon(dn){ const d=new Date(); d.setDate(d.getDate()+dn); d.setHours(12,0,0,0); return d; }
function weekendNoons(){
  const now=new Date(), dow=now.getDay(); const df=(5-dow+7)%7;
  return [localNoon(df), localNoon(df+1), localNoon(df+2)];
}
function pickSymbolCode(met,dateObj){
  const ts=met?.properties?.timeseries||[]; if(!ts.length) return null;
  const target=dateObj.getTime(); let best=null,diff=1e15;
  for(const row of ts){ const t=Date.parse(row.time); const d=Math.abs(t-target); if(d<diff){best=row;diff=d;} }
  if(!best) return null;
  const d=best.data||{};
  return d.next_6_hours?.summary?.symbol_code
      || d.next_1_hours?.summary?.symbol_code
      || d.next_12_hours?.summary?.symbol_code
      || null;
}

async function render(){
  const {x,y}=projectLonLat(OSLO.lon,OSLO.lat);
  const {ox,oy,w,h}=getRect();
  const px=ox+x*w, py=oy+y*h;

  const pin=document.getElementById("pin");
  pin.style.left=px+"px"; pin.style.top=py+"px";

  const icons=document.getElementById("icons");
  icons.style.left=(px+16)+"px"; icons.style.top=(py-24)+"px"; // til høyre for pin
  icons.innerHTML="";

  const dates=weekendNoons(); // default: helg
  try{
    const met=await fetchMet(OSLO.lat,OSLO.lon);
    dates.forEach(d=>{
      const code=pickSymbolCode(met,d);
      const img=document.createElement("img");
      if(code) img.src=ICON_BASE+code+".svg";
      else img.alt="ingen data";
      icons.appendChild(img);
    });
  }catch(e){ console.error(e); }
}

document.getElementById("mapimg").addEventListener("load", render);
window.addEventListener("resize", render);
</script>
</body>
</html>
