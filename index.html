<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vær – Oslo & Åndalsnes (Yr Locationforecast)</title>
  <style>
    :root {
      --bg: #0b1220;
      --card: #111a2e;
      --muted: #98a2b3;
      --text: #e6ecf4;
      --accent: #5eead4;
      --ring: #334155;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(1200px 800px at 10% -10%, #101a30 0%, var(--bg) 55%), var(--bg);
      color: var(--text);
    }
    .app {
      max-width: 1100px; margin: 32px auto; padding: 16px;
    }
    header { display:flex; flex-wrap: wrap; align-items: center; gap: 12px; margin-bottom: 16px; }
    header h1 { font-size: 20px; margin: 0; letter-spacing: 0.3px; font-weight: 650; }
    .controls { display:flex; gap: 8px; flex-wrap: wrap; }
    button.toggle {
      appearance: none; border: 1px solid var(--ring); background: #0f172a; color: var(--text);
      padding: 10px 14px; border-radius: 999px; cursor: pointer; font-weight: 600; letter-spacing: .2px;
    }
    button.toggle[aria-pressed="true"] { border-color: var(--accent); box-shadow: 0 0 0 2px #134e4a inset; }

    .grid { display:grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 850px) { .grid { grid-template-columns: 1fr 1fr; } }

    .card {
      border: 1px solid var(--ring); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));
      border-radius: 18px; padding: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .card header { justify-content: space-between; margin-bottom: 8px; }
    .loc {
      display:flex; align-items: baseline; gap: 10px; padding: 6px 10px; border-radius: 12px; background: #0c1528; border: 1px solid var(--ring);
    }
    .loc .name { font-size: 16px; font-weight: 700; }
    .loc .coords { color: var(--muted); font-size: 12px; }

    .days { display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .daybox {
      border: 1px solid var(--ring); border-radius: 14px; padding: 10px; background: #0e1a31;
      display:flex; flex-direction: column; align-items: center; gap: 6px; min-height: 160px;
    }
    .date { font-weight: 700; font-size: 13px; letter-spacing:.2px; }
    .iconwrap { width: 72px; height: 72px; display:grid; place-items:center; background: #0b1429; border-radius: 12px; border:1px solid var(--ring); }
    .iconwrap img { width: 64px; height: 64px; display:block; }
    .temp { font-size: 22px; font-weight: 800; }
    .meta { color: var(--muted); font-size: 12px; }

    .footer { color: var(--muted); font-size: 12px; margin-top: 16px; }
    .err { color: #fecaca; font-weight: 600; }
    a { color: var(--accent); text-decoration: none; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Værsymboler: Oslo & Åndalsnes</h1>
      <div class="controls" role="group" aria-label="Visningsvalg">
        <button class="toggle" id="btn-next3" aria-pressed="true">Neste 3 dager</button>
        <button class="toggle" id="btn-weekend" aria-pressed="false">Fri–Lør–Søn</button>
      </div>
    </header>

    <div id="grid" class="grid"></div>

    <div class="footer">
      Data: <a href="https://api.met.no/weatherapi/locationforecast/2.0/" target="_blank" rel="noreferrer">Yr / MET Norway – Locationforecast</a> · Ikoner: <a href="https://api.met.no/images/weathericons/" target="_blank" rel="noreferrer">MET Weather Icons</a>
      <br/>
      <strong>Merk:</strong> For produksjon anbefales det å rute forespørslene via en lett server/proxy som legger på en identifiserende <code>User-Agent</code> (f.eks. appnavn + kontakt). Se eksempel nederst i kildekoden.
    </div>
  </div>

  <script>
    // -------------------- Konfig --------------------
    const LOCATIONS = [
      { name: "Oslo", lat: 59.9139, lon: 10.7522 },
      { name: "Åndalsnes", lat: 62.5670, lon: 7.6870 },
    ];

    // Ikonbase. symbol_code kan brukes direkte (inkl. _day/_night/_polartwilight)
    const ICON_BASE = "https://api.met.no/images/weathericons/svg/"; // + symbol_code + ".svg"

    // Europe/Oslo tidsone for gruppering per dag
    const OSLO_TZ = "Europe/Oslo";

    // -------------------- Hjelpere --------------------
    const dayNames = ["Søn", "Man", "Tir", "Ons", "Tor", "Fre", "Lør"]; // Date.getDay()

    function toOslo(date) {
      // Returnerer en Date som representerer samme øyeblikk, men
      // vi bruker Intl til å hente local parts i Europe/Oslo ved formatering.
      return new Date(date);
    }

    function formatDateLabel(d) {
      const day = dayNames[new Intl.DateTimeFormat('no-NO', { timeZone: OSLO_TZ, weekday: 'short'}).formatToParts(d).find(p=>p.type==='weekday').value.startsWith('sø') ? 0 : d.getDay()];
      // Enklere og korrekt: bruk egen format for både ukedag og dato
      const f = new Intl.DateTimeFormat('no-NO', { timeZone: OSLO_TZ, weekday: 'short', day: 'numeric', month: 'short' });
      return f.format(d).replace(/\.$/, ''); // fjern evt. punktum etter mnd.
    }

    function startOfLocalDay(d) {
      return new Date(new Intl.DateTimeFormat('sv-SE', { timeZone: OSLO_TZ, year:'numeric', month:'2-digit', day:'2-digit'}).format(d) + 'T00:00:00');
    }

    function addDays(d, n) { const nd = new Date(d); nd.setDate(nd.getDate()+n); return nd; }

    function nextWeekendDates(ref = new Date()) {
      // Finn førstkommende fredag-lørdag-søndag i Europe/Oslo
      const refLocal = new Date(new Intl.DateTimeFormat('sv-SE', { timeZone: OSLO_TZ, year:'numeric', month:'2-digit', day:'2-digit', hour: '2-digit', minute: '2-digit', second:'2-digit'}).format(ref).replace(' ', 'T'));
      const day = refLocal.getDay(); // 0=Sun .. 6=Sat
      const daysToFriday = (5 - (day === 0 ? 7 : day)) % 7; // til 5 (Fre)
      const friday = startOfLocalDay(addDays(refLocal, daysToFriday >=0 ? daysToFriday : daysToFriday + 7));
      return [friday, addDays(friday,1), addDays(friday,2)];
    }

    function next3Dates(ref = new Date()) {
      const today = startOfLocalDay(ref);
      return [today, addDays(today,1), addDays(today,2)];
    }

    function pickClosestToNoon(times, targetDay) {
      // Velg datapunkt nærmest kl 12:00 lokal tid for gitt kalenderdag
      const noonLocal = new Date(new Intl.DateTimeFormat('sv-SE', { timeZone: OSLO_TZ, year:'numeric', month:'2-digit', day:'2-digit'}).format(targetDay) + 'T12:00:00');
      let best = null; let bestDiff = Infinity;
      for (const t of times) {
        const dt = new Date(t.time); // time er ISO UTC fra API
        // Sjekk at dt er samme lokale kalenderdag som targetDay
        const dtLocalYMD = new Intl.DateTimeFormat('sv-SE', { timeZone: OSLO_TZ, year:'numeric', month:'2-digit', day:'2-digit'}).format(dt);
        const tgtYMD = new Intl.DateTimeFormat('sv-SE', { timeZone: OSLO_TZ, year:'numeric', month:'2-digit', day:'2-digit'}).format(targetDay);
        if (dtLocalYMD !== tgtYMD) continue;
        const diff = Math.abs(new Date(dt).getTime() - noonLocal.getTime());
        if (diff < bestDiff) { bestDiff = diff; best = t; }
      }
      return best; // kan være null
    }

    // -------------------- API --------------------
    async function fetchForecast(lat, lon) {
      const url = `https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=${lat}&lon=${lon}`;
      // NB: I produksjon bør dette prox'ies via server for å sette identifiserende User-Agent.
      const res = await fetch(url, {
        headers: {
          // Browsere lar ikke sette User-Agent. Legg på valgfri X-Requested-With for egen kontroll.
          'Accept': 'application/json'
        }
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      // timeseries: [{ time, data: { instant: { details: { air_temperature, ... } }, next_1_hours: { summary: { symbol_code }, details: { precipitation_amount } }, ... }}]
      return data.properties.timeseries.map(ts => ({
        time: ts.time,
        temp: ts.data?.instant?.details?.air_temperature ?? null,
        symbol: ts.data?.next_1_hours?.summary?.symbol_code || ts.data?.next_6_hours?.summary?.symbol_code || null,
        precip: ts.data?.next_1_hours?.details?.precipitation_amount ?? ts.data?.next_6_hours?.details?.precipitation_amount ?? null,
      }));
    }

    // -------------------- Rendering --------------------
    function renderLocationCard(container, locName, lat, lon, mode, dataset) {
      const card = document.createElement('div');
      card.className = 'card';

      const head = document.createElement('header');
      const loc = document.createElement('div');
      loc.className = 'loc';
      loc.innerHTML = `<span class="name">${locName}</span><span class="coords">${lat.toFixed(3)}, ${lon.toFixed(3)}</span>`;
      head.appendChild(loc);
      card.appendChild(head);

      const daysWrap = document.createElement('div');
      daysWrap.className = 'days';

      const targetDates = (mode === 'weekend') ? nextWeekendDates(new Date()) : next3Dates(new Date());

      for (const d of targetDates) {
        const pick = pickClosestToNoon(dataset, d);
        const box = document.createElement('div');
        box.className = 'daybox';

        const lbl = document.createElement('div');
        lbl.className = 'date';
        lbl.textContent = formatDateLabel(d);

        const iconWrap = document.createElement('div');
        iconWrap.className = 'iconwrap';

        const temp = document.createElement('div');
        temp.className = 'temp';

        const meta = document.createElement('div');
        meta.className = 'meta';

        if (pick && pick.symbol) {
          const img = document.createElement('img');
          img.alt = pick.symbol;
          img.decoding = 'async';
          img.loading = 'lazy';
          img.src = ICON_BASE + encodeURIComponent(pick.symbol) + '.svg';
          iconWrap.appendChild(img);
          const t = (pick.temp !== null && pick.temp !== undefined) ? Math.round(pick.temp) + '°C' : '—';
          temp.textContent = t;
          meta.textContent = (pick.precip != null) ? `${pick.precip.toFixed(1)} mm` : '';
        } else {
          iconWrap.innerHTML = '<span style="font-size:12px;color:var(--muted);text-align:center;padding:4px">Ingen data</span>';
          temp.textContent = '—';
          meta.textContent = '';
        }

        box.appendChild(lbl);
        box.appendChild(iconWrap);
        box.appendChild(temp);
        box.appendChild(meta);
        daysWrap.appendChild(box);
      }

      card.appendChild(daysWrap);
      container.appendChild(card);
    }

    async function render(mode = 'next3') {
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      for (const loc of LOCATIONS) {
        const wrapper = document.createElement('div');
        grid.appendChild(wrapper);
        try {
          const series = await fetchForecast(loc.lat, loc.lon);
          renderLocationCard(wrapper, loc.name, loc.lat, loc.lon, mode, series);
        } catch (err) {
          wrapper.innerHTML = `<div class="card"><div class="err">Kunne ikke hente data for ${loc.name}: ${err.message}</div></div>`;
        }
      }
    }

    // -------------------- UI wiring --------------------
    const btnNext3 = document.getElementById('btn-next3');
    const btnWeekend = document.getElementById('btn-weekend');

    function setMode(nextMode) {
      const isWeekend = nextMode === 'weekend';
      btnNext3.setAttribute('aria-pressed', String(!isWeekend));
      btnWeekend.setAttribute('aria-pressed', String(isWeekend));
      render(isWeekend ? 'weekend' : 'next3');
    }

    btnNext3.addEventListener('click', () => setMode('next3'));
    btnWeekend.addEventListener('click', () => setMode('weekend'));

    // Initial
    render('next3');

    // -------------------- Eksempel: enkel proxy (Cloudflare Worker)
    /*
    export default {
      async fetch(request, env) {
        const url = new URL(request.url);
        if (url.pathname === '/forecast') {
          const lat = url.searchParams.get('lat');
          const lon = url.searchParams.get('lon');
          const upstream = `https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=${lat}&lon=${lon}`;
          const res = await fetch(upstream, {
            headers: {
              'User-Agent': 'Kreaturing-VaerDashboard/1.0 (kontakt: your-email@example.com)',
              'Accept': 'application/json',
            }
          });
          return new Response(res.body, {
            headers: { 'content-type': 'application/json', 'cache-control': 's-maxage=600' }
          });
        }
        return new Response('OK');
      }
    };
    */
  </script>
</body>
</html>
