<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Norgesvarsel</title>
  <style>
    :root { --bg:#0b132b; --fg:#eef; --muted:#9fb3c8; --card:#1c2541; --accent:#5bc0be; }
    body { margin:0; font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:var(--fg); }
    header { padding:16px 20px; border-bottom:1px solid #223; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    header h1 { font-size:18px; margin:0 10px 0 0; color:#fff; }
    .controls { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .seg { display:flex; background:#0f1a33; border:1px solid #2b3558; border-radius:10px; overflow:hidden; }
    .seg label { padding:8px 12px; cursor:pointer; color:var(--muted); }
    .seg input { display:none; }
    .seg input:checked + span { background:var(--accent); color:#001017; }
    .wrap { display:grid; grid-template-columns: 1fr; gap:12px; padding:14px; }
    .panel { background:var(--card); border:1px solid #2b3558; border-radius:14px; overflow:hidden; }
    .legend { display:flex; align-items:center; gap:16px; padding:12px 14px; border-bottom:1px solid #2b3558; }
    .legend small { color:var(--muted); }
    .mapbox { position:relative; min-height:60vh; }
    .mapbox img { width:100%; height:100%; object-fit:contain; display:block; }
    .pin { position:absolute; width:12px; height:12px; border-radius:50%; background:var(--accent); border:2px solid #001017; transform:translate(-50%,-50%); box-shadow:0 0 0 4px rgba(91,192,190,.2); }
    .loc-label { position:absolute; transform:translate(-50%,10px); color:#fff; font-size:12px; background:rgba(0,0,0,.35); padding:2px 6px; border-radius:6px; border:1px solid rgba(255,255,255,.15); white-space:nowrap; }
    #version-tag { position:absolute; bottom:8px; right:12px; background:rgba(0,0,0,.6); color:#fff; padding:4px 8px; font-size:12px; border-radius:6px; pointer-events:none; }
    .areas { display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:14px; padding:14px; }
    .area-card { background:#0f1a33; border:1px solid #2b3558; border-radius:12px; padding:10px 12px; }
    .area-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .area-name { font-weight:700; }
    .meta { font-size:11px; color:#9fb3c8; }
    .triplet { display:flex; gap:14px; }
    .icard { display:flex; flex-direction:column; align-items:center; gap:6px; background:#0f1a33; border:1px solid #2b3558; border-radius:10px; padding:8px 10px; width:90px; }
    .icard img { width:48px; height:48px; }
    .icard .label { font-weight:600; font-size:13px; }
    .footer { padding:12px 16px; font-size:12px; color:#b9c5d6; opacity:.8; }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ‡³ðŸ‡´ Norgesvarsel</h1>
    <div class="controls">
      <div class="seg" role="tablist" aria-label="Visning">
        <label><input type="radio" name="mode" value="weekend" checked><span>FÃ¸rstkommende helg</span></label>
        <label><input type="radio" name="mode" value="next3"><span>Neste 3 dager</span></label>
        <label><input type="radio" name="mode" value="plus7"><span>+7 til +9 dager</span></label>
      </div>
      <button id="refresh">Oppdater</button>
    </div>
  </header>

  <div class="wrap">
    <div class="panel">
      <div class="legend">
        <div>
          <strong id="legend-title">FÃ¸rstkommende helg</strong><br>
          <small id="legend-sub">Symboler rundt lunsjtid for fredagâ€“sÃ¸ndag (Europe/Oslo)</small>
        </div>
      </div>

      <div class="mapbox" id="mapbox">
        <img id="map" src="./no.svg" alt="Kart over Norge" />
        <div id="version-tag">Norgesvarsel v1.5</div>
        <!-- Pins legges inn av JS -->
      </div>

      <div id="areas" class="areas"></div>

      <div class="footer">
        Data: Â© MET Norway / yr (Forecast v0, locations/{id}/forecast). Ikoner: MET weathericons (SVG).
      </div>
    </div>
  </div>

<script>
  // ===== KONFIG =====
  const ICON_BASE = "https://cdn.jsdelivr.net/gh/metno/weathericons/weather/svg/";
  const TZ = "Europe/Oslo";

  // 10 omrÃ¥der med Yr-ID + ca. posisjon i prosent av kartets boks (finjustÃ©r ved behov)
  const AREAS = [
    { name:"Oslo og Ã¸stlandsomrÃ¥det",        id:"1-72837",   x:72, y:82 },
    { name:"Kristiansand og sÃ¸rlandet",      id:"1-2376",    x:60, y:94 },
    { name:"Ã…ndalsnes-omrÃ¥det og Romsdalen", id:"1-190429",  x:48, y:70 },
    { name:"Bergen og vestlandet",           id:"1-92416",   x:38, y:84 },
    { name:"Bohuslen og GÃ¶teborg-omrÃ¥det",   id:"2-2693301", x:52, y:90 },
    { name:"HenningsvÃ¦r og Lofoten",         id:"1-276748",  x:60, y:40 },
    { name:"Hemsedal og dalstrÃ¸ka innafor",  id:"5-25115",   x:56, y:79 },
    { name:"Jotunheimen (TurtagrÃ¸)",         id:"1-162272",  x:50, y:76 },
    { name:"TrÃ¸ndelag og Midt-Norge",        id:"1-211102",  x:54, y:62 },
    { name:"Lillehammer, Hafjell og SjusjÃ¸en", id:"1-143669", x:58, y:83 },
  ];

  // --- TidsverktÃ¸y (Europe/Oslo) ---
  const toLocalOslo = (d) => new Date(d.toLocaleString("en-GB", { timeZone: TZ }));
  function localNoon(daysFromToday=0) {
    const now = toLocalOslo(new Date());
    const t = new Date(now);
    t.setDate(now.getDate() + daysFromToday);
    t.setHours(12,0,0,0);
    return t;
  }
  function upcomingWeekendNoons() {
    const now = toLocalOslo(new Date());
    const dow = now.getDay(); // 0=Sun ... 6=Sat
    const daysToFriday = (5 - dow + 7) % 7;
    return [localNoon(daysToFriday), localNoon(daysToFriday+1), localNoon(daysToFriday+2)];
  }

  // --- UI-tekst ---
  function setLegend(mode) {
    const t = document.getElementById("legend-title");
    const s = document.getElementById("legend-sub");
    if (mode === "weekend") {
      t.textContent = "FÃ¸rstkommende helg";
      s.textContent = "Symboler rundt lunsjtid for fredagâ€“sÃ¸ndag (Europe/Oslo)";
    } else if (mode === "next3") {
      t.textContent = "Neste 3 dager";
      s.textContent = "Symboler ca. kl. 12:00 lokal tid";
    } else {
      t.textContent = "+7 til +9 dager";
      s.textContent = "Symboler ca. kl. 12:00 lokal tid";
    }
  }

  // --- Yr API via ID (NB: ikke prÃ¸v Ã¥ sette User-Agent i browser) ---
  async function fetchById(id) {
    const url = `https://www.yr.no/api/v0/locations/${id}/forecast`;
    const res = await fetch(url); // uten UA-header i browser
    if (!res.ok) throw new Error(`Yr API ${res.status}`);
    return res.json();
  }

  // --- Finn longInterval som dekker lokal 12:00 for gitt dato ---
  function pickLongSymbolForDate(forecast, targetLocalNoon) {
    const longs = forecast?.longIntervals || [];
    if (!longs.length) return { code:null, interval:null };

    const t = targetLocalNoon.getTime();
    for (const it of longs) {
      const start = new Date(it.start).getTime();
      const end   = new Date(it.end).getTime();
      if (t >= start && t < end) {
        const code = it.symbol || it.symbolCode || it.symbol_code || null;
        return { code, interval: it };
      }
    }
    // Fallback: nÃ¦rmeste start
    let best=null, bestDiff=Infinity;
    for (const it of longs) {
      const start = new Date(it.start).getTime();
      const diff = Math.abs(start - t);
      if (diff < bestDiff) { best = it; bestDiff = diff; }
    }
    const code = best ? (best.symbol || best.symbolCode || best.symbol_code || null) : null;
    return { code, interval: best };
  }

  // --- Kort for ett symbol ---
  function cardForSymbol(dateObj, symbolCode) {
    const div = document.createElement("div");
    div.className = "icard";
    const img = document.createElement("img");
    const label = document.createElement("div"); label.className = "label";
    const sub = document.createElement("div"); sub.className = "meta";

    const dd = dateObj.toLocaleDateString("no-NO", { weekday:"short", day:"2-digit", month:"short", timeZone: TZ });
    label.textContent = dd;

    if (symbolCode) {
      img.src = ICON_BASE + symbolCode + ".svg";
      img.alt = symbolCode.replaceAll("_"," ");
      sub.textContent = symbolCode;
    } else {
      img.alt = "ingen data";
      sub.textContent = "mangler symbol";
    }
    div.appendChild(img); div.appendChild(label); div.appendChild(sub);
    return div;
  }

  // --- Pins pÃ¥ kartet ---
  function clearPins() {
    document.querySelectorAll(".pin, .loc-label").forEach(n => n.remove());
  }
  function addPin(name, xPercent, yPercent) {
    const mapbox = document.getElementById("mapbox");
    const pin = document.createElement("div"); pin.className = "pin";
    const lab = document.createElement("div"); lab.className = "loc-label"; lab.textContent = name;

    const rect = mapbox.getBoundingClientRect();
    const left = (xPercent/100) * rect.width;
    const top  = (yPercent/100) * rect.height;
    pin.style.left = left + "px"; pin.style.top = top + "px";
    lab.style.left = left + "px"; lab.style.top = top + "px";

    mapbox.appendChild(pin); mapbox.appendChild(lab);
  }

  // --- Render hele siden ---
  async function render() {
    const mode = document.querySelector('input[name="mode"]:checked').value;
    setLegend(mode);

    let dates = [];
    if (mode === "weekend") {
      dates = upcomingWeekendNoons();
    } else if (mode === "next3") {
