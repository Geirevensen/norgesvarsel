<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Norge-v√¶r (MVP)</title>
  <style>
    .mapbox img { width: 100%; height: 100%; object-fit: contain; display: block; }
    :root { --bg:#0b132b; --fg:#eef; --muted:#9fb3c8; --card:#1c2541; --accent:#5bc0be; }
    body { margin:0; font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:var(--fg); }
    header { padding:16px 20px; border-bottom:1px solid #223; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    header h1 { font-size:18px; margin:0 10px 0 0; color:#fff; }
    .controls { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .controls label { opacity:.9; }
    select, button { background:#111a2f; color:var(--fg); border:1px solid #2b3558; padding:8px 10px; border-radius:8px; }
    .seg { display:flex; background:#0f1a33; border:1px solid #2b3558; border-radius:10px; overflow:hidden; }
    .seg label { padding:8px 12px; cursor:pointer; color:var(--muted); }
    .seg input { display:none; }
    .seg input:checked + span { background:var(--accent); color:#001017; }
    .wrap { display:grid; grid-template-columns: 1fr; gap:12px; padding:14px; }
    .panel { background:var(--card); border:1px solid #2b3558; border-radius:14px; overflow:hidden; }
    .mapbox { position:relative; min-height:60vh; }
    .mapbox svg { width:100%; height:100%; display:block; background:linear-gradient(180deg,#0e1b34,#0a1629); }
    .legend { display:flex; align-items:center; gap:16px; padding:12px 14px; border-bottom:1px solid #2b3558; }
    .legend small { color:var(--muted); }
    .icons { display:flex; gap:18px; padding:14px; flex-wrap:wrap; }
    .icard { display:flex; flex-direction:column; align-items:center; gap:6px; background:#0f1a33; border:1px solid #2b3558; border-radius:12px; padding:10px 12px; width:120px; }
    .icard img { width:64px; height:64px; }
    .icard .label { font-weight:600; }
    .notice { color:#c6d8ff; font-size:13px; opacity:.9; padding:0 14px 14px; }
    .footer { padding:12px 16px; font-size:12px; color:#b9c5d6; opacity:.8; }
    .pin { position:absolute; width:12px; height:12px; border-radius:50%; background:var(--accent); border:2px solid #001017; transform:translate(-50%,-50%); box-shadow:0 0 0 4px rgba(91,192,190,.2); }
    .loc-label { position:absolute; transform:translate(-50%,10px); color:#fff; font-size:12px; background:rgba(0,0,0,.35); padding:2px 6px; border-radius:6px; border:1px solid rgba(255,255,255,.15);}
    .help { color:#a8bed9; }
    a { color:#8ed7ff; }
  </style>
</head>
<body>
  <header>
    <h1>üá≥üá¥ Norge-v√¶r</h1>
    <div class="controls">
      <label for="place">Sted:</label>
      <select id="place">
        <option value="59.9133,10.7389,Oslo">Oslo</option>
        <option value="60.39299,5.32415,Bergen">Bergen</option>
        <option value="63.4305,10.3951,Trondheim">Trondheim</option>
        <option value="69.6492,18.9553,Troms√∏">Troms√∏</option>
        <option value="58.96998,5.73311,Stavanger">Stavanger</option>
        <option value="67.2828,14.4049,Bod√∏">Bod√∏</option>
      </select>

      <div class="seg" role="tablist" aria-label="Visning">
        <label><input type="radio" name="mode" value="next3" checked><span>Neste 3 dager</span></label>
        <label><input type="radio" name="mode" value="weekend"><span>F√∏rstkommende helg</span></label>
        <label><input type="radio" name="mode" value="plus7"><span>+7 til +9 dager</span></label>
      </div>

      <button id="refresh">Oppdater</button>
    </div>
  </header>

  <div class="wrap">
    <div class="panel">
      <div class="legend">
        <div><strong id="legend-title">Neste 3 dager</strong><br><small id="legend-sub">Symboler cirka kl. 12:00 lokal tid (Europe/Oslo)</small></div>
        <div class="help">‚Ä¢ Klikk ¬´Oppdater¬ª etter √• ha endret valg</div>
      </div>
      <div class="mapbox" id="mapbox">
        <!-- Skalerbart Norges-kart -->
          <img id="map" src="./no.svg" alt="Kart over Norge" />
        <div id="pin" class="pin" style="left: 55%; top: 85%;" title="Valgt sted"></div>
        <div id="pinlabel" class="loc-label" style="left: 55%; top: 85%;">Oslo</div>
      </div>
      <div class="icons" id="icons"></div>
      <div class="notice">
        Ikoner er MET/yr sine offisielle v√¶rikoner (SVG) og mappes direkte fra <code>symbol_code</code> i Locationforecast 2.0.
        Kilden er MET Norway / yr. Husk egen <code>User-Agent</code> i API-kallet.
      </div>
    </div>
    <div class="footer">
      Data: ¬© MET Norway / yr (Locationforecast 2.0). Ikoner: MET weathericons (SVG). Denne siden er en enkel demonstrator.
    </div>
  </div>

<script>
  // ===== KONFIG =====
  const USER_AGENT = "Geir Evensen/geirevensen@hotmail.com ‚Äì hobbyprosjekt for √• vise v√¶r";
  // MET weather icons (GitHub). symbol_code + ".svg".
  // Repo: https://github.com/metno/weathericons  (bruk via jsDelivr CDN for enkel hosting)
  const ICON_BASE = "https://cdn.jsdelivr.net/gh/metno/weathericons/weather/svg/"; // partlycloudy_day.svg, etc.

  // Hjelpefunksjon: finn valgt modus
  const modeRadio = () => document.querySelector('input[name="mode"]:checked').value;

  // Oppdater tittel
  function setLegend(mode) {
    const t = document.getElementById("legend-title");
    const s = document.getElementById("legend-sub");
    if (mode === "next3") {
      t.textContent = "Neste 3 dager";
      s.textContent = "Symboler cirka kl. 12:00 lokal tid (Europe/Oslo)";
    } else if (mode === "weekend") {
      t.textContent = "F√∏rstkommende helg (fre‚Äìs√∏n)";
      s.textContent = "Symboler rundt lunsjtid for fredag, l√∏rdag og s√∏ndag";
    } else {
      t.textContent = "+7 til +9 dager";
      s.textContent = "Symboler cirka kl. 12:00 lokal tid (Europe/Oslo)";
    }
  }

  // Tidsverkt√∏y ‚Äì alltid Europe/Oslo
  const TZ = "Europe/Oslo";
  const toLocalOslo = (d) => new Date(d.toLocaleString("en-GB", { timeZone: TZ }));

  function localNoon(daysFromToday=0) {
    const now = toLocalOslo(new Date());
    const target = new Date(now);
    target.setDate(now.getDate() + daysFromToday);
    target.setHours(12,0,0,0);
    return target;
  }

  function upcomingWeekendNoons() {
    // Finn f√∏rstkommende fredag, l√∏rdag, s√∏ndag (Europe/Oslo)
    const now = toLocalOslo(new Date());
    const dow = now.getDay(); // 0=Sun ... 5=Fri 6=Sat
    const daysToFriday = (5 - dow + 7) % 7;
    const fri = localNoon(daysToFriday);
    const l√∏r = localNoon(daysToFriday + 1);
    const s√∏n = localNoon(daysToFriday + 2);
    return [fri, l√∏r, s√∏n];
  }

  // Hent forecast
  async function fetchForecast(lat, lon, altitude=null) {
    const params = new URLSearchParams({ lat, lon });
    if (altitude != null) params.set("altitude", altitude);
    const url = `https://api.met.no/weatherapi/locationforecast/2.0/compact?${params.toString()}`;
    const res = await fetch(url, { headers: { "User-Agent": USER_AGENT } });
    if (!res.ok) throw new Error(`MET API ${res.status}`);
    return res.json();
  }

  // Velg symbol for n√¶rmeste tidsstempel rundt lokal 12:00.
  function pickSymbolForDate(forecast, targetLocalNoon) {
    const timeseries = forecast.properties?.timeseries || [];
    // Finn n√¶rmeste tidspunkt i timeserien til targetLocalNoon
    let best = null, bestDiff = Infinity;
    const targetISO = targetLocalNoon.toISOString().slice(0,19); // j√§mf√∂r uten ms
    const targetTime = targetLocalNoon.getTime();

    for (const t of timeseries) {
      const when = new Date(t.time).getTime();
      const diff = Math.abs(when - targetTime);
      if (diff < bestDiff) { best = t; bestDiff = diff; }
    }
    if (!best) return { code: null, at: null };

    // Foretrekk next_6_hours.symbol_code, ellers next_1_hours, ellers next_12_hours
    const details = best.data || {};
    let code = details.next_6_hours?.summary?.symbol_code
            || details.next_1_hours?.summary?.symbol_code
            || details.next_12_hours?.summary?.symbol_code
            || null;
    return { code, at: best.time };
  }

  // Lag kort for ett symbol
  function cardForSymbol(dateObj, symbolCode, whenISO) {
    const div = document.createElement("div");
    div.className = "icard";
    const img = document.createElement("img");
    const label = document.createElement("div");
    label.className = "label";
    const sub = document.createElement("div");
    sub.style.color = "#a9bfd7";
    sub.style.fontSize = "12px";

    const dd = dateObj.toLocaleDateString("no-NO", { weekday:"short", day:"2-digit", month:"short", timeZone: TZ });
    label.textContent = dd;

    if (symbolCode) {
      img.src = ICON_BASE + symbolCode + ".svg";
      img.alt = symbolCode.replaceAll("_"," ");
      sub.textContent = symbolCode;
    } else {
      img.alt = "ingen data";
      sub.textContent = "mangler symbol";
    }

    div.appendChild(img);
    div.appendChild(label);
    div.appendChild(sub);
    return div;
  }

  function setPinLabel(name) {
    document.getElementById("pinlabel").textContent = name;
  }

  function setPinPositionForDemo(name) {
    // Siden vi ikke kjenner koordinatsystemet til din innlimte SVG, plasserer vi mark√∏ren omtrent:
    const map = document.getElementById("mapbox");
    const pin = document.getElementById("pin");
    const lab = document.getElementById("pinlabel");
    const pos = {
      "Oslo": [0.55, 0.85],
      "Bergen": [0.38, 0.86],
      "Trondheim": [0.54, 0.62],
      "Troms√∏": [0.68, 0.26],
      "Stavanger": [0.35, 0.92],
      "Bod√∏": [0.60, 0.45],
    };
    const [x,y] = (pos[name] || [0.55,0.85]);
    const rect = map.getBoundingClientRect();
    const left = x * rect.width;
    const top = y * rect.height;
    pin.style.left = left + "px";
    pin.style.top = top + "px";
    lab.style.left = left + "px";
    lab.style.top = top + "px";
  }

  async function render() {
    const mode = modeRadio();
    setLegend(mode);

    const [latStr, lonStr, name] = document.getElementById("place").value.split(",");
    const lat = parseFloat(latStr), lon = parseFloat(lonStr);

    setPinLabel(name);
    setPinPositionForDemo(name);

    document.getElementById("icons").innerHTML = "";

    let dates = [];
    if (mode === "next3") {
      dates = [localNoon(1), localNoon(2), localNoon(3)];
    } else if (mode === "weekend") {
      dates = upcomingWeekendNoons(); // fredag‚Äìs√∏ndag
    } else {
      dates = [localNoon(7), localNoon(8), localNoon(9)];
    }

    let forecast;
    try {
      forecast = await fetchForecast(lat, lon);
    } catch (e) {
      const box = document.getElementById("icons");
      const err = document.createElement("div");
      err.className = "notice";
      err.innerHTML = `Kunne ikke hente data fra MET: <b>${e.message}</b>. 
      Sjekk at du har satt en egen <code>User-Agent</code> i koden.`;
      box.appendChild(err);
      return;
    }

    const box = document.getElementById("icons");
    dates.forEach(d => {
      const { code, at } = pickSymbolForDate(forecast, d);
      box.appendChild(cardForSymbol(d, code, at));
    });
  }

  document.getElementById("refresh").addEventListener("click", render);
  document.getElementById("place").addEventListener("change", render);
  document.querySelectorAll('input[name="mode"]').forEach(r => r.addEventListener("change", render));

  // F√∏rste kj√∏ring
  render();
</script>
</body>
</html>
